generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SUPERVISOR
  CAJERO
  GERENTE
}

enum PaymentMethod {
  EFECTIVO
  DEBITO
  CREDITO
  TARJETA
  TRANSFERENCIA
   QR
  MIXTO
  CUENTA_CORRIENTE
}

enum DiscrepancyReason {
  ERROR
  GASTO
  RETIRO
  OTRO
}

enum TransferStatus {
  PENDIENTE
  EN_TRANSITO
  COMPLETADO
  CANCELADO
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(CAJERO)
  active    Boolean  @default(true)
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shifts    Shift[]
  sales     Sale[]
  createdSettlements   Settlement[] @relation("SettlementCreator")
  confirmedSettlements Settlement[] @relation("SettlementConfirmer")
  createdTransfers     StockTransfer[] @relation("TransferCreator")
  shippedTransfers     StockTransfer[] @relation("TransferShipper")
  confirmedTransfers   StockTransfer[] @relation("TransferConfirmer")
  createdEntries       StockEntry[]    @relation("EntryCreator")
}

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  address   String?
  phone     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
  stocks    Stock[]
  shifts    Shift[]
  sales     Sale[]
  ownedProducts Product[] @relation("ProductOwner")
  targetSettlements Settlement[] @relation("SettlementTarget")
  sourceSettlements Settlement[] @relation("SettlementSource")
  sourceTransfers   StockTransfer[] @relation("TransferSource")
  targetTransfers   StockTransfer[] @relation("TransferTarget")
  stockEntries      StockEntry[]
  priceLists        PriceList[]
}

model MeasurementUnit {
  id          String   @id @default(cuid())
  name        String   @unique
  symbol      String   @unique
  decimals    Int      @default(2)
  factor      Decimal  @default(1.0) @db.Decimal(12, 4)
  isBase      Boolean  @default(false)
  baseUnitId  String?
  baseUnit    MeasurementUnit? @relation("UnitConversion", fields: [baseUnitId], references: [id])
  childUnits  MeasurementUnit[] @relation("UnitConversion")
  products    Product[] @relation("BaseUnit")
  saleItems   SaleItem[]
}

model Category {
  id              String    @id @default(cuid())
  name            String    @unique
  defaultMinStock Decimal   @default(0) @db.Decimal(12, 3)
  createdAt       DateTime  @default(now())
  products        Product[]
}

model Product {
  id          String         @id @default(cuid())
  code        String         @unique
  ean         String?        @unique
  name        String
  basePrice   Decimal        @default(0) @db.Decimal(10, 2)
  minStock    Decimal        @default(0) @db.Decimal(12, 3)
  active      Boolean        @default(true)
  categoryId  String?
  category    Category?      @relation(fields: [categoryId], references: [id])
  baseUnitId  String?
  baseUnit    MeasurementUnit? @relation("BaseUnit", fields: [baseUnitId], references: [id])
  branchId    String?
  branch      Branch?        @relation("ProductOwner", fields: [branchId], references: [id])
  stocks      Stock[]
  prices      ProductPrice[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  saleItems   SaleItem[]
  transferItems TransferItem[]
  stockEntryItems StockEntryItem[]

  @@index([name])
}

model Stock {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])
  quantity  Decimal @default(0) @db.Decimal(12, 3)
  minStock  Decimal @default(0) @db.Decimal(12, 3)
  @@unique([productId, branchId])
}

model PriceList {
  id         String         @id @default(cuid())
  name       String         @unique
  percentage Decimal        @default(0) @db.Decimal(5, 2)
  active     Boolean        @default(true)
  branchId   String?
  branch     Branch?        @relation(fields: [branchId], references: [id])
  prices     ProductPrice[]
  sales      Sale[]
}

model ProductPrice {
  id          String     @id @default(cuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id])
  priceListId String
  priceList   PriceList  @relation(fields: [priceListId], references: [id])
  price       Decimal    @db.Decimal(10, 2)
  @@unique([productId, priceListId])
}

model Shift {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  branchId       String?
  branch         Branch?   @relation(fields: [branchId], references: [id])
  openedAt       DateTime  @default(now())
  closedAt       DateTime?
  initialCash    Decimal   @default(0) @db.Decimal(10, 2)
  declaredAmount Decimal?  @db.Decimal(10, 2)
  expectedAmount Decimal?  @db.Decimal(10, 2)
  discrepancy    Decimal?  @db.Decimal(10, 2)
  discrepancyReason DiscrepancyReason?
  discrepancyNote   String?
  sales          Sale[]
}

enum SaleType {
  SALE
  REFUND
}

model Sale {
  id            String        @id @default(cuid())
  number        Int           @default(autoincrement())
  type          SaleType      @default(SALE)
  relatedSaleId String?
  relatedSale   Sale?         @relation("RefundRelation", fields: [relatedSaleId], references: [id])
  refunds       Sale[]        @relation("RefundRelation")
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  branchId      String?
  branch        Branch?       @relation(fields: [branchId], references: [id])
  shiftId       String
  shift         Shift         @relation(fields: [shiftId], references: [id])
  priceListId   String?
  priceList     PriceList?    @relation(fields: [priceListId], references: [id])
  total         Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  cashReceived  Decimal?      @db.Decimal(10, 2)
  change        Decimal?      @db.Decimal(10, 2)
  adjustment    Decimal       @default(0) @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime      @default(now())
  items         SaleItem[]
  paymentDetails PaymentDetail[]
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id])
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  unitId    String?
  unit      MeasurementUnit? @relation(fields: [unitId], references: [id])
  quantity  Decimal @db.Decimal(12, 3)
  price     Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  @@index([saleId])
  @@index([productId])
}

model SystemSetting {
  id              String   @id @default(cuid())
  key             String   @unique
  useDecimals     Boolean  @default(true)
  isClearingEnabled Boolean  @default(false)
  enableCustomerAccounts Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model StockTransfer {
  id              String         @id @default(cuid())
  number          Int            @default(autoincrement())
  status          TransferStatus @default(PENDIENTE)
  sourceBranchId  String
  sourceBranch    Branch         @relation("TransferSource", fields: [sourceBranchId], references: [id])
  targetBranchId  String
  targetBranch    Branch         @relation("TransferTarget", fields: [targetBranchId], references: [id])
  createdById     String
  createdBy       User           @relation("TransferCreator", fields: [createdById], references: [id])
  shippedById     String?
  shippedBy       User?          @relation("TransferShipper", fields: [shippedById], references: [id])
  confirmedById   String?
  confirmedBy     User?          @relation("TransferConfirmer", fields: [confirmedById], references: [id])
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  items           TransferItem[]
}

model TransferItem {
  id                    String        @id @default(cuid())
  transferId            String
  transfer              StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId             String
  product               Product       @relation(fields: [productId], references: [id])
  quantity              Decimal       @db.Decimal(12, 3)
  receivedQuantity      Decimal?      @db.Decimal(12, 3)
  issuanceJustification String?
  receptionJustification String?
  receptionPhotoUrl     String?
}

enum SettlementStatus {
  PENDING
  CONFIRMED
  REJECTED
}

model Settlement {
  id              String           @id @default(cuid())
  amount          Decimal          @db.Decimal(10, 2)
  sourceBranchId  String
  sourceBranch    Branch           @relation("SettlementSource", fields: [sourceBranchId], references: [id])
  targetBranchId  String
  targetBranch    Branch           @relation("SettlementTarget", fields: [targetBranchId], references: [id])
  status          SettlementStatus @default(PENDING)
  createdById     String
  createdBy       User             @relation("SettlementCreator", fields: [createdById], references: [id])
  confirmedById   String?
  confirmedBy     User?            @relation("SettlementConfirmer", fields: [confirmedById], references: [id])
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model StockEntry {
  id                String           @id @default(cuid())
  number            Int              @default(autoincrement())
  date              DateTime         @default(now())
  supplierName      String?
  invoiceNumber     String?
  invoiceUrl        String?
  totalAmount       Decimal?         @db.Decimal(12, 2)
  notes             String?
  branchId          String
  branch            Branch           @relation(fields: [branchId], references: [id])
  createdById       String
  createdBy         User             @relation("EntryCreator", fields: [createdById], references: [id])
  items             StockEntryItem[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model StockEntryItem {
  id            String     @id @default(cuid())
  entryId       String
  stockEntry    StockEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  productId     String
  product       Product    @relation(fields: [productId], references: [id])
  quantity      Decimal    @db.Decimal(12, 3)
  costPrice     Decimal    @db.Decimal(12, 2)
}

model Customer {
  id           String      @id @default(cuid())
  name         String
  document     String?     @unique
  email        String?
  phone        String?
  address      String?
  balance      Decimal     @default(0) @db.Decimal(12, 2)
  maxCredit    Decimal     @default(0) @db.Decimal(12, 2)
  active       Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  sales        Sale[]
  transactions CustomerTransaction[]
}

model CustomerTransaction {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  saleId      String?
  type        String   // SALE, PAYMENT, ADJUSTMENT
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  createdAt   DateTime @default(now())
}

model PaymentDetail {
  id        String        @id @default(cuid())
  saleId    String
  sale      Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  method    PaymentMethod
  amount    Decimal       @db.Decimal(10, 2)
}
